<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="/images/icon.png">
  
    <title>Piturnah.xyz | Rewriting my site in Haskell (using Hakyll)</title>
  
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/blog.css">

  <link rel="alternate" type="application/atom+xml" href="/atom.xml">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- and it's easy to individually load additional languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/haskell.min.js"></script>

  <script>hljs.highlightAll();</script>

  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js" integrity="sha512-uHOKtSfJWScGmyyFr2O2+efpDx2nhwHU2v7MVeptzZoiC7bdF6Ny/CmZhN2AwIK1oCFiVQQ5DA/L9FSzyPNu6Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script type="module" src="https://cdn.jsdelivr.net/gh/dpecos/mastodon-comments@6fe36e7e308412cc02f26ae1477987a75d32e58f/mastodon-comments.js"></script>
  
</head>

<body>
  <header>
    <script src="/assets/header-scroll.js"></script>
    <a href="/" class="home-button">piturnah<span class="domain">.xyz</span></a>
    <nav>
        <ul>
            <li><a href="https://ko-fi.com/piturnah">Ko-fi</a></li>
            <li><a href="https://codeberg.org/Piturnah">Codeberg</a></li>
            <li><a href="https://hachyderm.io/@piturnah">Mastodon</a></li>
            <li>
                <a href="https://github.com/Piturnah/piturnah.github.io">
                    <svg
                      viewBox="0 0 98 96"
                      width="32"
                      height="34"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"
                        fill="currentColor"
                      />
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>


  <div class="main-content">
    <div class="box">
      
      
        <p><b>Update</b>: You can now see a live version of the Hakyll code that generates this site <a href="/site.hs">here</a>.</p>
      
      
        <h1>Rewriting my site in Haskell (using Hakyll)</h1>
        <p>-# 2025-03-13 #-</p>
      
      <p>The other day I spent a couple of hours learning about, and rewriting this website in, <a href="https://jaspervdj.be/hakyll/">Hakyll</a> — a site generator library for Haskell. In this post my plan is to write a little about why I did this and what the process was like, and whether it may be a good idea for your site, too!</p>
<h2 id="why">Why?</h2>
<p>When I originally made this website back in 2019, it was just some HTML and CSS. It had one page, the root, with some links at the top to my GitHub<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and &amp;c. Simple and it worked. As I started adding other stuff, like embedding web builds of some of my games, I got by with nothing more than a little bit of <a href="https://en.wikipedia.org/wiki/JQuery">jQuery</a> to make stuff like reusing components more convenient.</p>
<p>A couple of years later, after having spent some of the intervening time doing freelance web development,<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> I had the bright idea to rewrite everything using <a href="https://svelte.dev/">Svelte</a>, specifically as a static site generator. I quickly realised this was far too much infrastructure for a tiny personal homepage and reverted back to my original setup.</p>
<p>Still though, I wanted <em>more</em> flexibility. I wanted to do fun things at build time. But the other, less enterprise-y, solutions like <a href="https://jekyllrb.com/">Jekyll</a> or <a href="https://gohugo.io/">Hugo</a> also seemed too restrictive in the way of tying you to a specific framework. I wanted something site-agnostic. Not a lot more than “turn my markdown into html! let me put my documents in a layout template! let me do arbitrary transformations on the text!”, but without making me do things <em>The Jeykll Way</em>, or whatever it may be.</p>
<h3 id="shovel">Shovel</h3>
<p>All this led to me eventually writing my own site generator: <a href="https://codeberg.org/Piturnah/shovel-ssg">Shovel</a>. Shovel was written in Rust, and with the goal of being as agnostic as possible about how you want to lay out your stuff. Perhaps unsurprisingly, my naïve approach to this only resulted in <em>yet another site generator framework</em>. Worse still, it wasn’t nearly as capable as the existing solutions, as whenever I needed a new feature I’d be stuck for weeks on how to implement it in a site-agnostic way.</p>
<h3 id="discovering-hakyll">Discovering Hakyll</h3>
<p>Eventually I made a great realisation. <em>I</em> know how I want to transform the documents in my site’s build process and I just need a convenient tool to express that. We already have such tools: programming languages. We already have high-level programming languages which are turing complete. The perfect site generator isn’t some CLI tool with a restrictive framework and mountains of awkward configuration, it’s just a library in an ergonomic high-level language. <a href="https://www.akpain.net/">My friend Abi</a> already understood this; her site being built by a bespoke Python script.</p>
<p>I posted a toot about this thought and within minutes I got <a href="https://mathstodon.xyz/@jj@types.pl/114141092743989492">a reply</a> recommending that I check out Hakyll. Hakyll immediately seemed like what I was looking for. I could have pivoted Shovel into being a more bespoke thing more explicitly just for my site, but the problem with Rust is that it <em>sucks</em> if you don’t need the low-level access and speed. Haskell, on the other hand, is a beautifully ergonomic language which is a joy to write for those tasks where you don’t need Rust’s main offerings.</p>
<h2 id="how">How?</h2>
<p>Hakyll’s API is centered primarily around a couple of monads it exposes. The first is the <code>Rules</code> monad, which you can find the docs for <a href="https://hackage.haskell.org/package/hakyll-4.16.6.0/docs/Hakyll-Core-Rules.html">here</a>. Hakyll’s entry point is a function</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">hakyll ::</span> <span class="dt">Rules</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span></code></pre></div>
<p>which takes some rules and “does IO”, i.e., generates your site based on them. In a rule you usually quantify over some source files — which you can retrieve via a glob — and specify things such as what route they should be mapped to and how they should be compiled. For example, here is the rule which turns most of my <code>.md</code> files into rendered pages:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mdRule <span class="ot">=</span> match <span class="st">&quot;**.md&quot;</span> <span class="op">$</span> route mdRoute <span class="op">&gt;&gt;</span> compileWith pandocCompiler</span></code></pre></div>
<p>where <code>mdRoute</code> and <code>compileWith</code> are also defined by me, not as part of the library. I’m basically just saying, “for files ending in <code>.md</code>, render them with <a href="https://pandoc.org/">pandoc</a> to this specific path.” For those wondering, <code>mdRoute</code> just transforms the original filepath by moving it into a subdirectory and changing the name to <code>index.html</code>. This is super readable and convenient in Haskell.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">mdRoute ::</span> <span class="dt">Routes</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mdRoute <span class="ot">=</span> customRoute <span class="op">$</span> (<span class="op">&lt;/&gt;</span> <span class="st">&quot;index.html&quot;</span>) <span class="op">.</span> dropExtension <span class="op">.</span> toFilePath</span></code></pre></div>
<p>For comparison, here was the corresponding Rust code from Shovel:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Give the path of an input file and it will create the relevant directory tree in the output</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// directory, returning a `PathBuf` to where the output file will go.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_output_path(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> build_path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span><span class="op">,</span> file_path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Path</span><span class="op">,</span> dir<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">PathBuf</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> relative_path <span class="op">=</span> file_path<span class="op">.</span>strip_prefix(<span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>root)<span class="op">?;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> output_path <span class="op">=</span> <span class="dt">PathBuf</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">.</span>push(build_path)<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">.</span>push(relative_path)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> parent <span class="op">=</span> <span class="cf">if</span> dir <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">.</span>set_extension(<span class="st">&quot;&quot;</span>)<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">.</span>clone()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        output_path</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>parent()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>context(<span class="st">&quot;failed to get file parent&quot;</span>)<span class="op">?</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>to_path_buf()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="pp">fs::</span>create_dir_all(parent)<span class="op">.</span>context(<span class="st">&quot;failed to create parent directory&quot;</span>)<span class="op">?;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(output_path)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> build(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> use_ws<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> output_path <span class="op">=</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>get_output_path(<span class="dt">Path</span><span class="pp">::</span>new(path)<span class="op">,</span> file<span class="op">.</span>path()<span class="op">,</span> <span class="cn">true</span>)<span class="op">?;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">.</span>push(<span class="st">&quot;index.html&quot;</span>)<span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> buf <span class="op">=</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="pp">File::</span>create(output_path)<span class="op">.</span>context(<span class="st">&quot;failed to open file for writing&quot;</span>)<span class="op">?;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>To be a bit fair, the Rust code is also doing filesystem stuff whereas the Haskell one is only the bit concerned with transforming the path. But it’s clear that even the path transformation was a <em>pain</em> before and gross to read<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> — this is one of the clear benefits to using a higher-level language.</p>
<p>You specify how a rule should compile (e.g., what layouts to apply, what compiler to use, &amp;c.) using the <code>Compiler</code> monad (<a href="https://hackage.haskell.org/package/hakyll-4.16.6.0/docs/Hakyll-Core-Compiler.html">docs</a>). For example, here’s the bit of my site config which extends a given compiler with the layout from the given <code>Item</code>’s metadata (glossing over the details of <code>Item</code>s and metadata for now).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">compileWith ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">Rules</span> ()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>compileWith compiler <span class="ot">=</span> compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    identifier <span class="ot">&lt;-</span> getUnderlying</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    layout <span class="ot">&lt;-</span> getMetadataField identifier <span class="st">&quot;layout&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    compiler <span class="op">&gt;&gt;=</span> <span class="kw">case</span> layout <span class="kw">of</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> <span class="st">&quot;none&quot;</span> <span class="ot">-&gt;</span> <span class="fu">pure</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> path <span class="ot">-&gt;</span> loadAndApplyTemplate (fromFilePath path) defaultContext</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> loadAndApplyTemplate <span class="st">&quot;_templates/default.html&quot;</span> defaultContext</span></code></pre></div>
<h3 id="contexts">Contexts</h3>
<p>Compilation is done in a certain <code>Context</code> (<a href="https://hackage.haskell.org/package/hakyll-4.16.6.0/docs/Hakyll-Web-Template-Context.html">docs</a>), which basically consists of a bunch of key-value pairs. It’s implemented as a <code>Monoid</code> so it’s super convenient to work with.</p>
<p>One of the places you can access the values from the context is in templating. I will showcase a place I have used this on the site: the blog! My blog layout is very similar to my default layout (<a href="/faq">example</a>), but with extra stuff such as the <a href="https://github.com/dpecos/mastodon-comments">Mastodon comments</a> section. The context system allows me to use the same template for both, where for example I can specify that I want to include certain header stuff only when the <code>"blog"</code> key is present:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>$if(blog)$</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    type=</span><span class="st">&quot;module&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    src</span><span class="op">=</span><span class="st">&quot;https://cdn.jsdelivr.net/gh/dpecos/mastodon-comments@6fe36e7e308412cc02f26ae1477987a75d32e58f/mastodon-comments.js&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  </span><span class="dt">/&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>$endif$</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span></code></pre></div>
<p>which I can make true by just appending it to the <code>defaultContext</code> in the relevant compiler:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ...</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;blog/**.md&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        route mdRoute</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        compile <span class="op">$</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            pandocCompiler</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">&gt;&gt;=</span> loadAndApplyTemplate</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;_templates/default.html&quot;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                    (defaultContext <span class="op">&lt;&gt;</span> emptyField <span class="st">&quot;blog&quot;</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ...</span></span></code></pre></div>
<h3 id="the-downsides">The downsides</h3>
<p>Not everything is perfect about Hakyll, believe it or not. The first thing that frustrated me was that it doesn’t really seem to be possible to do templating in a regular file and compile that, you can only do it via a layout template. This resulted in me having to do a little janky solution to render my <code>index.html</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;_templates/*&quot;</span> <span class="op">.</span> compile <span class="op">$</span> templateCompiler</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    create [<span class="st">&quot;index.html&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        route idRoute</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        compile <span class="op">.</span> loadAndApplyTemplate <span class="st">&quot;_templates/index.html&quot;</span> defaultContext <span class="op">$</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Item</span> <span class="st">&quot;index.html&quot;</span> <span class="st">&quot;&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ...</span></span></code></pre></div>
<p>what I’m doing here is basically compiling <code>_templates/index.html</code> as a template, and then creating a new empty item called “index.html” which is not associated to any file and rendering it into the aforementioned template. This isn’t the end of the world, and, the biggest benefit of using Hakyll is that we’re working in a turing-complete high-level language. I can just make a special extension for files I want to render this way, and write some code to handle them this way automatically. For now I only need it for the root, and so this solution is fine.</p>
<p>Still, it seems a little weird that this apparently basic want is not included in the library. Maybe it is, and I just couldn’t find it?</p>
<p>The next downside, and this is a major one, is the new CI compile time. On CI, my current solution is to compile all the dependencies on the server and build the site. With shovel this took a couple of minutes, but pandoc is <em>big</em>, and so my new CI takes about 20 minutes in total. Normally this would be fine, but since I have to go and make a second edit after every blog post to include the meta for the mastodon comments section, it means that for the first 20 minutes the post is live there will be no comments. Which is a little bit annoying. This may be something I will find a better solution for in the future.</p>
<h2 id="conclusions">Conclusions</h2>
<p>Hakyll is fantastic and I’m so glad I switched to using it. I would highly recommend for anyone with a similar use-case to me: small websites where you care a lot about build flexibility. It only took a couple of hours to port my site, and the code is <em>tiny</em>! In fact, it’s less than 50 lines. Here is the entire <code>site.hs</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Hakyll</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Pandoc.Options</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ot">emptyField ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>emptyField name <span class="ot">=</span> field name (<span class="fu">const</span> <span class="op">.</span> <span class="fu">pure</span> <span class="op">$</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ot">mdRoute ::</span> <span class="dt">Routes</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>mdRoute <span class="ot">=</span> customRoute <span class="op">$</span> (<span class="op">&lt;/&gt;</span> <span class="st">&quot;index.html&quot;</span>) <span class="op">.</span> dropExtension <span class="op">.</span> toFilePath</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ot">compileWith ::</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>) <span class="ot">-&gt;</span> <span class="dt">Rules</span> ()</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>compileWith compiler <span class="ot">=</span> compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    identifier <span class="ot">&lt;-</span> getUnderlying</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    layout <span class="ot">&lt;-</span> getMetadataField identifier <span class="st">&quot;layout&quot;</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    compiler <span class="op">&gt;&gt;=</span> <span class="kw">case</span> layout <span class="kw">of</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> <span class="st">&quot;none&quot;</span> <span class="ot">-&gt;</span> <span class="fu">pure</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> path <span class="ot">-&gt;</span> loadAndApplyTemplate (fromFilePath path) defaultContext</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> loadAndApplyTemplate <span class="st">&quot;_templates/default.html&quot;</span> defaultContext</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;_templates/*&quot;</span> <span class="op">.</span> compile <span class="op">$</span> templateCompiler</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    create [<span class="st">&quot;index.html&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        route idRoute</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        compile <span class="op">.</span> loadAndApplyTemplate <span class="st">&quot;_templates/index.html&quot;</span> defaultContext <span class="op">$</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Item</span> <span class="st">&quot;index.html&quot;</span> <span class="st">&quot;&quot;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;blog/**.md&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        route mdRoute</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        compile <span class="op">$</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            pandocCompilerWith</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                defaultHakyllReaderOptions</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                defaultHakyllWriterOptions{writerHTMLMathMethod <span class="ot">=</span> <span class="dt">MathJax</span> <span class="st">&quot;&quot;</span>}</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">&gt;&gt;=</span> loadAndApplyTemplate</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;_templates/default.html&quot;</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                    (defaultContext <span class="op">&lt;&gt;</span> emptyField <span class="st">&quot;blog&quot;</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;**.md&quot;</span> <span class="op">$</span> route mdRoute <span class="op">&gt;&gt;</span> compileWith pandocCompiler</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;**.html&quot;</span> <span class="op">$</span> route idRoute <span class="op">&gt;&gt;</span> compileWith getResourceBody</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    match <span class="st">&quot;**&quot;</span> <span class="op">$</span> route idRoute <span class="op">&gt;&gt;</span> compile copyFileCompiler</span></code></pre></div>
<p>I’m looking forward to leveraging it to do more cool stuff, like add an Atom feed for this blog.</p>
<p>I hope you enjoyed reading. If you did, feel free to leave a comment. If you didn’t, also leave a comment! Bye for now.</p>
<h2 id="bonus-atom-feed">Bonus: Atom feed</h2>
<p><strong>Edit</strong>: I implemented the atom feed. It was so simple that I had to come back and show it. This is literally all it required:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> hakyll <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ...</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    create [<span class="st">&quot;atom.xml&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        route idRoute</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        compile <span class="op">$</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            loadAll <span class="st">&quot;blog/*&quot;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">&gt;&gt;=</span> recentFirst</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">&gt;&gt;=</span> renderAtom</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">FeedConfiguration</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                        { feedTitle <span class="ot">=</span> <span class="st">&quot;piturnah.xyz&quot;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                        , feedDescription <span class="ot">=</span> <span class="st">&quot;Pit&#39;s blog&quot;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                        , feedAuthorName <span class="ot">=</span> <span class="st">&quot;Peter Hebden&quot;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                        , feedAuthorEmail <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                        , feedRoot <span class="ot">=</span> <span class="st">&quot;https://piturnah.xyz&quot;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                    defaultContext</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ...</span></span></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Still using GitHub? <a href="https://sfconservancy.org/GiveUpGitHub/">Give it up</a> today.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Those of you who know me even slightly may find this fact hilariously incongruent.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>There are some nightly-only features which do make it a <em>little</em> better.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
    </div>

    
    <mastodon-comments host=mathstodon.xyz user=piturnah tootId=114152300811331994></mastodon-comments>
    
  </div>
</body>
</html>
